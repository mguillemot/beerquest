- @css = 'bar'
%table.cols
  %tr.small
    %td.small
    %td
    %td.small
  %tr
    %td.small
    %td.unique-col
      %table.bar-area
        %tr
          %td.bar-name{:colspan => 2}
            %h1= @bar.name
            %a{:href => @bar.url, :target => '_blank'}= @bar.url
            .member-count
              = t 'bar.member_count', :count => number_with_delimiter(@bar.total_members)
              = "-"
              = t 'bar.beer_count', :count => number_with_delimiter(@bar.total_beers)
          %td.bar-logo
            %a.start-tutorial{:href => 'javascript:void(0)'}
              = image_tag @bar.banner_small, :alt => @bar.name, :class => 'bar-banner'
        %tr
          %td.play-field{:colspan => 2}
            #game
          %td.sidebar{:rowspan => 3}
            = render :partial => 'scores'
        %tr.bottom1
          %td.actuality
            RSS
          %td.clients
            = render :partial => 'messages'
        %tr.bottom2
          %td.actuality
            Stats
    %td.small.shadow
  %tr.small
    %td.small
    %td.shadow
    %td.small.shadow

#message-dialog{:title => t('bar.endgame.message.title')}
  %textarea#message-content.invalid{:rows => 3, :cols => 50}

:javascript
  $(function() {
    $('#game').flash({
      swf: "#{client_swf}",
      width: 520,
      height: 320,
      flashvars: {
        mode: "#{@mode}",
        lang: "#{I18n.locale}",
        token: "#{@replay.token}",
        requiredVersion: #{required_version}
      }
    });
    $('#message-dialog').dialog({
      autoOpen: false,
      modal: true,
      resizable: false,
      position: [125, 320],
      buttons: {
        "#{t('bar.endgame.message.button')}": function() {
          $.post("#{endgame_message_url}", {
            token: "#{@replay.token}",
            message: $('#message-content').val()
          }, function() {
            $.get("#{async_bar_messages_url(@bar)}");
          });
          $(this).dialog('close');
        }
      },
      close: function() {
        $.get("#{async_bar_messages_url(@bar)}");
      }
    });
    $('#message-content').bind('keyup change', function()
    {
      var len = $(this).val().length;
      if (len >= 5 && len <= 160)
      {
        $(this).removeClass('invalid');
      }
      else
      {
        $(this).addClass('invalid');
      }
    });
    $('.start-tutorial').click(startTutorial);
  });

  function startTutorial()
  {
    $.colorbox({
      width: "514px",
      height: "380px",
      iframe: true,
      href: "#{tutorial_url(1)}"
    });
  }

  function endTutorial()
  {
    $.colorbox.close();
  }

  function gameStarted()
  {
    setTimeout('startTutorial', 2000);
  }

  function endOfGame(mode, score, scoreGoal, personalHigh, barHigh)
  {
    /*setTimeout(function() {
      $('#message-dialog').dialog('open');
    }, 3000);*/
  }

  function soloBoast(score)
  {
    var url = "#{BeerQuest::FB_APP_URL}#{home_path}";
    var attachment = {
                       name: "#{t('bar.endgame.boast.post_title')}",
                       href: url,
                       //caption: "",
                       description: "#{t('bar.endgame.boast.post_message_pre')}" + score + "#{t('bar.endgame.boast.post_message_post')}",
                       media: [
                         {
                           type: 'image',
                           src: "#{static_asset_url('bq-90x90.png')}",
                           href: url
                         }
                       ]
                     };
    var links = [
                  {
                    text: "#{t('bar.endgame.boast.action')}",
                    href: url
                  }
                ];
    FB.ui(
    {
       method: "stream.publish",
       user_message_prompt: "#{t('bar.endgame.boast.prompt')}",
       //message: "",
       attachment: attachment,
       action_links: links 
    }, function(response)
    {
      $.post("#{postwall_url}", {
        token: "#{@replay.token}",
        from_location: "soloBoast",
        post_id: (response && response.post_id) ? response.post_id : null
      });
    });
  }

  function soloPlayAgain()
  {
    location.reload();
  }
