- @css = 'bar'
%table.cols
  %tr.small
    %td.small
    %td
    %td.small
  %tr
    %td.small
    %td.unique-col
      %table.bar-area
        %tr
          %td.bar-name{:colspan => 2}
            %table.vs
              %tr
                %td.player-me
                  .name= @me.full_name
                  .scores
                    %span.loose= t 'challenge.title.loose_count', :count => @me.total_victories
                    = " / "
                    %span.respect= t 'challenge.title.respect_count', :count => @me.total_defeats
                %td.portrait-me
                  = image_tag @me.profile_picture, :alt => @me.full_name, :class => 'portrait'
                %td.vs
                  %div= t 'challenge.title.vs'
                  .round= t 'challenge.title.round', :round => @challenge.round
                %td.portrait-opponent
                  = image_tag @challenger.profile_picture, :alt => @challenger.full_name, :class => 'portrait'
                %td.player-opponent
                  .name= @challenger.full_name
                  .scores
                    %span.loose= t 'challenge.title.loose_count', :count => @challenger.total_victories
                    = " / "
                    %span.respect= t 'challenge.title.respect_count', :count => @challenger.total_defeats
        %tr
          %td.play-field{:colspan => 2}
            #game
          %td.sidebar
            %ul.tabs
              %li.last
                %a{:href => 'javascript:void(0)'}= t 'challenge.right.history.title'
            .panes
              .pane#messages
                = render :partial => 'challenge_messages'
        %tr.bottom
          %td.bar-scores
          %td.bar-scores
          %td.bar-stats
            .header
              = t 'challenge.stats.friends_stats'
            .stat
              .section= t 'challenge.stats.games'
              .value= t 'challenge.stats.victories_friend', :count => @me.total_victories_with(@challenger)
              .value= t 'challenge.stats.defeats_friend', :count => @me.total_defeats_with(@challenger)
            .stat
              .section= t 'challenge.stats.rounds_title'
              .value= t 'challenge.stats.rounds_total', :count => @me.total_rounds_with(@challenger)
            .stat
              .section= t 'challenge.stats.total_beers'
              .value
                = image_tag 'mini-biere.png', :alt => t('beers')
                = number_with_delimiter(@me.total_score_with(@challenger))
            %br
            .header
              = t 'challenge.stats.global_stats'
            .stat
              .section= t 'challenge.stats.games'
              .value= t 'challenge.stats.victories_global', :count => @me.total_victories
              .value= t 'challenge.stats.defeats_global', :count => @me.total_defeats
            .stat
              .section= t 'challenge.stats.rounds_title'
              .value= t 'challenge.stats.rounds_total', :count => @me.total_rounds
            .stat
              .section= t 'challenge.stats.total_beers'
              .value
                = image_tag 'mini-biere.png', :alt => t('beers')
                = number_with_delimiter(@me.total_score_challenge)
    %td.small.shadow
  %tr.small
    %td.small
    %td.shadow
    %td.small.shadow

#message-dialog{:title => t('challenge.endgame.message.title')}
  %textarea#message-content{:rows => 3, :cols => 50}

:javascript
  $(function() {
    $('#game').flash({
      swf: "/swf/BeerQuest-#{Game::Constants::VERSION}.swf",
      width: 520,
      height: 320,
      flashvars: {
        mode: "#{@mode}",
        lang: "#{I18n.locale}",
        token: "#{@replay.token}",
        requiredVersion: #{Game::Constants::VERSION},
        goal: #{@challenge.required_score}
      }
    });
    $('#message-dialog').dialog({
      autoOpen: false,
      modal: true,
      resizable: false,
      position: [125, 320],
      buttons: {
        "#{t('challenge.endgame.message.button')}": function() {
          $.post("#{endgame_message_url}", {
            token: "#{@replay.token}",
            message: $('#message-content').val()
          }, function() {
            $.get("#{async_challenge_messages_url(@challenge)}");
          });
          $(this).dialog('close');
        }
      },
      close: function() {
        $.get("#{async_challenge_messages_url(@challenge)}");
      }
    });
  });

  function endOfGame()
  {
    setTimeout(function() {
      $('#message-dialog').dialog('open');
    }, 3000);
  }

  function vsBoastVictory(score, goal)
  {

  }

  function vsBoastDefeat(score, goal)
  {
    FB.ui(
    {
      method: "stream.publish",
      user_message_prompt: "#{t('bar.endgame.boast.prompt')}",
      message: "Je me suis fait baiser à " + goal + " bières !!!",
      target_id: #{@challenge.sent_by.facebook_id},
      action_links:
      [{
        text: "#{t('bar.endgame.boast.action')}",
        href: "#{BeerQuest::FB_APP_URL}#{home_path}"
      }],
      attachement: 
      {
        name: "Turlututu",
        caption: "Titre du turlututu",
        media:
        [{
          'type': "image",
          'src': "http://erhune.iobb.net:8081/images/bq-75-75.png",
          'href': "#{BeerQuest::FB_APP_URL}#{home_path}"
        }],
        description: "Description du beau turlututu que voici !",
        href: "#{BeerQuest::FB_APP_URL}#{home_path}"
      }
    }, function(response)
    {
      if (response && response.post_id)
      {
        //alert('Post was published.');
      }
      else
      {
        //alert('Post was not published.');
      }
   });
  }

  function vsProvoke(goal)
  {
    
    alert("Mur de l'ami > T'ES TROP NUL MON POTE !");
  }

  function vsPlayAgain(score, goal)
  {
    FB.ui(
    {
      method: "stream.publish",
      user_message_prompt: "#{t('bar.endgame.boast.prompt')}",
      message: "Tu m'as bien niqué à " + goal + " bières, mon salaud !!!",
      target_id: #{@challenge.sent_by.facebook_id},
      action_links: [
        { text: "#{t('bar.endgame.boast.action')}", href: "#{BeerQuest::FB_APP_URL}#{home_path}" }
      ],
      attachement: {media: [
      {
        type: "image",
        src: "http://erhune.iobb.net:8081/images/bq-75-75.png",
        href: "#{BeerQuest::FB_APP_URL}#{home_path}"
      }]}
    });
  }
