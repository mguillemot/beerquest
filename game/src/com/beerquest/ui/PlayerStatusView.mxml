<?xml version="1.0"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml"
         xmlns:ui="com.beerquest.ui.*"
         width="185" horizontalAlign="center" verticalGap="0"
         creationComplete="init()">
    <mx:Style>
        .score {
            fontFamily: Kro;
            fontSize: 32;
            color: white;
            textAlign: right;
        }

        .remaining-turns {
            fontSize: 18;
            color: white;
            textAlign: center;
        }
    </mx:Style>
    <mx:Script><![CDATA[
        import com.beerquest.Capacity;
        import com.beerquest.Constants;
        import com.beerquest.Game;
        import com.beerquest.PlayerData;
        import com.beerquest.events.BeerCollectedEvent;
        import com.beerquest.events.GameEvent;
        import com.beerquest.events.PissEvent;
        import com.greensock.TweenLite;

        [Bindable]
        public var game:Game;

        [Bindable]
        public function get player():PlayerData {
            return _player;
        }

        [Bindable]
        public function set player(value:PlayerData):void {
            _player = value;
            _player.addEventListener(GameEvent.PARTIAL_BEERS_CHANGED, onPartialBeersChanged);
            _player.addEventListener(GameEvent.FULL_BEERS_CHANGED, onFullBeersChanged);
        }

        public function get tokenEntryPoint():Point {
            return stack.stageEntryPoint;
        }

        public function locateCapacity(capacity:Capacity):Point {
            if (player.capacities.getItemAt(1) == capacity) {
                return localToGlobal(new Point(capa1.x + capa1.width / 2, capa1.y + capa1.height / 2));
            } else {
                return localToGlobal(new Point(capa0.x + capa0.width / 2, capa0.y + capa0.height / 2));
            }
        }

        private function init():void {
            addEventListener(BeerCollectedEvent.BEER_COLLECTED, onBeerCollected);
        }

        private function onBeerCollected(e:BeerCollectedEvent):void {
            player.fullBeers += 5;

            vfx.y = -vfx.height / 2 + 30;
            vfx.alpha = 1;
            TweenLite.to(vfx, 1, {alpha:0, y:"-20"});
        }

        private function onPartialBeersChanged(e:GameEvent):void {
            switch (_player.stackCompletion) {
                case 1:
                    arrow.source = Arrow1;
                    break;
                case 2:
                    arrow.source = Arrow2;
                    break;
                case 3:
                    arrow.source = Arrow3;
                    break;
                default:
                    arrow.source = Arrow0;
                    break;
            }
        }

        private function onFullBeersChanged(e:GameEvent):void {
            scoreIcon.scaleX = scoreIcon.scaleY = 1;
            var tween:TweenLite = new TweenLite(scoreIcon, 0.3, {scaleX:1.1, scaleY:1.1, onComplete:function():void {
                tween.reverse();
            }});
        }

        private function onMouseOverPiss(e:Event):void {
            //            pissText.setStyle("color", "#ffbaba");
            if (!game.gameOver) {
                wcButton.source = WcIconHover;
            }
        }

        private function onMouseOutPiss(e:Event):void {
            //            pissText.setStyle("color", "white");
            wcButton.source = WcIcon;
        }

        private function onClickPiss(e:Event):void {
            if (!game.gameOver) {
                dispatchEvent(new PissEvent(player));
            }
        }

        private function and(a:Boolean, b:Boolean):Boolean {
            return (a && b);
        }

        private var _player:PlayerData;

        [Embed(source="../../../wc-actif.png")]
        private static var WcIcon:Class;

        [Embed(source="../../../wc-over.png")]
        private static var WcIconHover:Class;

        [Embed(source="../../../fleche-0.png")]
        private static var Arrow0:Class;

        [Embed(source="../../../fleche-1.png")]
        private static var Arrow1:Class;

        [Embed(source="../../../fleche-2.png")]
        private static var Arrow2:Class;

        [Embed(source="../../../fleche-3.png")]
        private static var Arrow3:Class;
        ]]></mx:Script>
    <mx:NumberFormatter id="scoreFormatter" useThousandsSeparator="true" decimalSeparatorTo=","
                        thousandsSeparatorTo="."/>

    <mx:Canvas width="100%"
               toolTip="Tours de jeu restant. Buvez du jus de tomate pour tenir le coup !">
        <ui:ProgressBar x="12" y="12" width="170" height="16" progress="{game.remainingTurns/Constants.INITIAL_TOTAL_TURNS*100}" emptyColor="0x00789f"
                        fullColorLight="0x00bbf9" fullColorDark="0x0098d6"/>
        <mx:Image source="@Embed(source='../../../barre-tours.png')"/>
        <mx:Label y="3" width="30" text="{game.remainingTurns}" styleName="remaining-turns">
            <mx:filters>
                <mx:GlowFilter blurX="3" blurY="3" alpha="1" color="0x000000" quality="3"/>
            </mx:filters>
        </mx:Label>
    </mx:Canvas>

    <mx:Spacer height="5"/>

    <mx:Canvas width="100%"
               toolTip="Attention, à 100% : vomito (bloque 5 cases) ! Mangez des Cahouètes !">
        <ui:ProgressBar x="12" y="12" width="170" height="16" progress="{player.vomit}" emptyColor="0x619f00"
                        fullColorLight="0xbbf900" fullColorDark="0x82d500" alert="true"/>
        <mx:Image source="@Embed(source='../../../barre-vomi.png')"/>
    </mx:Canvas>

    <mx:Spacer height="5"/>

    <mx:Canvas width="100%"
               toolTip="Attention, à partir de 80% : innondation (bloque les lignes du fond) !">
        <ui:ProgressBar x="12" y="12" width="170" height="16" progress="{player.piss}" emptyColor="0x9f9600"
                        fullColorLight="0xfbe400" fullColorDark="0xcd1be00"/>
        <mx:Image x="60" y="3" id="wcButton" source="{WcIcon}" mouseOver="onMouseOverPiss(event)"
                  mouseOut="onMouseOutPiss(event)" click="onClickPiss(event)"
                  visible="{player.piss >= 80}"/>
        <mx:Image source="@Embed(source='../../../barre-pisse.png')"/>
    </mx:Canvas>

    <mx:Spacer height="10"/>

    <mx:Canvas width="100%">
        <mx:Image source="@Embed(source='../../../fond-score-srack.png')"/>
        <mx:Canvas toolTip="Ton score. Il augmente de 1 pour chaque bière bue.">
            <mx:Canvas x="5" y="2" width="120">
                <mx:Label id="collectedBeers" text="{player.fullBeers}" width="100%" styleName="score">
                    <mx:filters>
                        <mx:DropShadowFilter distance="2" angle="45" blurX="0" blurY="0" alpha="1" color="0x111111"/>
                    </mx:filters>
                </mx:Label>
            </mx:Canvas>
            <mx:Image id="scoreIcon" x="130" y="7" source="@Embed(source='../../../collected-beer.png')"/>
        </mx:Canvas>
        <mx:Canvas x="4" y="57" width="170" height="11" backgroundColor="0x000000" backgroundAlpha="0"
                   toolTip="Collecte 3 jetons de la même couleur pour gagner 5 bouteilles supplémentaires !">
            <ui:TokenCollectionView id="stack" player="{player}"/>
        </mx:Canvas>
        <mx:Image id="arrow" x="161" y="33" source="{Arrow0}"/>
        <ui:FullBeerFx id="vfx" x="{-vfx.width / 2 + 140}" y="{-vfx.height / 2 + 30}" alpha="0" value="5"/>
    </mx:Canvas>

    <mx:Spacer height="10"/>

    <ui:CapacityView id="capa0" player="{player}" capacity="{player.capacities.getItemAt(0) as Capacity}"
                     clickable="{!game.gameOver}"/>
    <!--<mx:Spacer height="4"/>-->
    <ui:CapacityView id="capa1" player="{player}" capacity="{player.capacities.getItemAt(1) as Capacity}"
                     clickable="{!game.gameOver}"/>
</mx:VBox>
