<?xml version="1.0"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
               xmlns:s="library://ns.adobe.com/flex/spark"
               xmlns:mx="library://ns.adobe.com/flex/mx"
               xmlns:ui="com.beerquest.ui.*"
               creationComplete="init()"
               width="760" height="630">
    <fx:Style>
        @font-face
        {
            src: url("kronika.ttf")
        ;
            fontFamily: Kro
        ;
            embedAsCFF: false
        ;
            advancedAntiAliasing: true
        ;
        }

        .game-type {
            fontFamily: Kro;
            fontSize: 16;
            color: #753e00;
        }
    </fx:Style>
    <fx:Script><![CDATA[
        import com.beerquest.Game;
        import com.beerquest.PlayerData;
        import com.beerquest.events.BeerCollectedEvent;
        import com.beerquest.events.CapacityEvent;
        import com.beerquest.events.GameEvent;
        import com.beerquest.events.GemsSwappedEvent;
        import com.beerquest.events.PissEvent;
        import com.beerquest.events.VomitEvent;

        private function init():void {
            addEventListener(GemsSwappedEvent.GEMS_SWAPPED, onGameEvent);
            addEventListener(BeerCollectedEvent.BEER_COLLECTED, onGameEvent);
            addEventListener(CapacityEvent.CAPACITY_GAINED, onGameEvent);
            addEventListener(VomitEvent.VOMIT, onGameEvent);
            addEventListener(PissEvent.PISS, onGameEvent);

            game.me.addEventListener(GameEvent.VOMIT_CHANGED, onVomitChanged);

            /*try {
             ExternalInterface.addCallback("testJs", testJs);
             } catch (e:Error) {
             trace("Impossible to connect to ExternalInterface.")
             } */

            var loader:Loader = new Loader();
            banner.addChild(loader);
            loader.load(new URLRequest("http://erhune.iobb.net/images/banner.jpg"));
        }

        private function onGameEvent(e:GameEvent):void {
            game.handleEvent(e);
        }

        private function onVomitChanged(e:Event):void {
            if (game.me.vomit >= 100) {
                boardView.createVomit();
                boardView.createVomit();
                boardView.createVomit();
                boardView.createVomit();
                boardView.createVomit();
                game.me.vomit = 70;
            }
        }

        /*public function testJs():void {
         Alert.show("coucou de la part du JS!!");
         }

         private function sendAjax():void {
         var request:URLRequest = new URLRequest("/account");
         //            request.contentType = "text/xml";
         //            request.data = dataXML.toXMLString();
         //            request.method = URLRequestMethod.POST;
         var loader:URLLoader = new URLLoader();
         loader.addEventListener(Event.COMPLETE, completeHandler);
         try {
         loader.load(request);
         trace("Request sent.");
         } catch (e:ArgumentError) {
         trace("An ArgumentError has occurred.");
         } catch (e:SecurityError) {
         trace("A SecurityError has occurred.");
         }
         }

         /private function completeHandler(event:Event):void
         {
         trace("Request completed.");
         var loader:URLLoader = URLLoader(event.target);
         var variables:URLVariables = new URLVariables(loader.data);
         Alert.show("toto=" + variables.toto);
         }

         private function callJs():void {
         try {
         ExternalInterface.call("callFromFlex", "plup");
         } catch (e:Error) {
         trace("Impossible to connect to ExternalInterface.")
         }
         } */

        public var game:Game = new Game(
                new PlayerData("Jeano Babouin", "Le bois-sans-soif", 89),
                new PlayerData("Mattiou Guillegay", "Le Saint-Bernard", 42),
                "Le Des-Murges Bar", "Paris - France", 18, 0, 23, 0);
        ]]></fx:Script>
    <mx:Image id="banner" x="0" y="492" width="771" height="144"/>
    <mx:Image source="@Embed(source='background-transp.png')"/>
    <ui:PlayerDataView x="35" y="60" player="{game.me}"/>
    <ui:PlayerDataView x="435" y="60" player="{game.opponent}" mirror="true"/>
    <mx:VBox x="220" y="10" width="320" horizontalAlign="center" verticalGap="0">
        <mx:Image source="@Embed(source='battle-biture.png')"/>
        <mx:Spacer height="15"/>
        <mx:Image source="@Embed(source='vs.png')"/>
        <mx:HBox verticalAlign="middle" horizontalGap="2">
            <mx:Label text="Duel" styleName="game-type"/>
            <mx:Image source="@Embed(source='collected-beer-small.png')"/>
            <mx:Label text="152" styleName="game-type"/>
        </mx:HBox>
    </mx:VBox>
    <ui:PlayerStatusView x="25" y="170" player="{game.me}"/>
    <ui:PlayerStatusView x="560" y="170" player="{game.opponent}" clickable="false"/>
    <mx:Label text="Available moves: {boardView.availableMoves}" x="10" y="10"/>
    <mx:Label text="Combo: {boardView.combo}" x="10" y="30"/>
    <ui:BoardView x="220" y="158" width="320" height="320" id="boardView" game="{game}"/>
    <!--<mx:Label x="10" y="450" text="Token is {FlexGlobals.topLevelApplication.parameters.token}"/>-->
    <!--<mx:Button x="200" y="450" label="AJAX" click="sendAjax()"/>-->
    <!--<mx:Button x="300" y="450" label="Call JS" click="callJs()"/>-->
    <mx:Label id="remainingTurns" x="220" y="476" width="320"
              text="Il est {game.currentTime} | Reste {game.remainingTurns} coups Ã  boire"
              textAlign="center"/>
    <mx:Canvas x="0" y="492">
        <mx:Label x="445" y="10" width="300" color="white" text="{game.barName}" textAlign="center"
                  fontSize="24"
                  fontWeight="bold" fontStyle="italic">
            <mx:filters>
                <mx:DropShadowFilter distance="2" angle="45" blurX="0" blurY="0" alpha="1" color="0x111111"/>
            </mx:filters>
        </mx:Label>
        <mx:Label x="445" y="36" width="300" color="white" text="{game.barLocation} | {game.barOperationTime}"
                  textAlign="center"
                  fontWeight="bold" fontStyle="italic" fontSize="12">
            <mx:filters>
                <mx:DropShadowFilter distance="2" angle="45" blurX="0" blurY="0" alpha="1" color="0x111111"/>
            </mx:filters>
        </mx:Label>
    </mx:Canvas>
</s:Application>
